<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagnostic Complete ‚Äî Diagnostic Wizard</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="global-nav.js" defer></script>
  </head>
  <body>
    <main class="page">
      <section class="card" aria-labelledby="screen-title">
        <div class="eyebrow">Diagnostic Complete</div>
        <p class="route">Route: /diagnostic/results</p>
        <h1 id="screen-title">‚úÖ Diagnostic Complete</h1>
        <p class="helper-text">
          Thank you for completing the diagnostic wizard. Below is a summary of the information collected.
        </p>

        <div id="diagnosticSummary" style="margin-top: 24px;">
          <!-- Diagnostic summary will be displayed here by JavaScript -->
        </div>

        <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 12px; border-left: 3px solid #3b82f6;">
          <p style="font-size: 14px; color: #1e40af; font-weight: 600;">
            üìã Next Steps
          </p>
          <p style="font-size: 14px; color: #1e40af; margin-top: 8px;">
            Based on the diagnostic information collected, recommendations and troubleshooting steps will be provided here.
          </p>
        </div>

        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="primary" onclick="window.location.href='index.html'">
            ‚Üê Start New Diagnostic
          </button>
          <button id="exportButton" class="secondary" onclick="exportDiagnosticSummary()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
              <path d="M14 10V12.6667C14 13.0203 13.8595 13.3594 13.6095 13.6095C13.3594 13.8595 13.0203 14 12.6667 14H3.33333C2.97971 14 2.64057 13.8595 2.39052 13.6095C2.14048 13.3594 2 13.0203 2 12.6667V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4.66669 6.66666L8.00002 10L11.3334 6.66666" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 10V2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Export Summary
          </button>
        </div>
      </section>
    </main>

    <script src="diagnostic-utils.js"></script>
    <script>
      // Display all collected diagnostic parameters
      const params = new URLSearchParams(window.location.search);
      const summaryContainer = document.getElementById('diagnosticSummary');

      if (summaryContainer) {
        const summary = document.createElement('div');
        summary.className = 'diagnostic-info-container';

        const title = document.createElement('h3');
        title.textContent = 'Diagnostic Summary';
        title.className = 'diagnostic-info-title';
        summary.appendChild(title);

        // Group parameters by category
        const categories = {
          'Scope & Target': ['scope', 'target'],
          'Timing Pattern': ['timing', 'intermittent', 'recent_change'],
          'Environment': ['device', 'os', 'connection'],
          'Quick Checks': ['high_latency', 'low_bandwidth', 'dns_issues', 'dns_ms', 'latency_ms', 'ttfb_ms', 'throughput_mbps'],
          'Diagnostic Path': ['diagnostic_path'],
          'Network Diagnostic': ['vpn_issue', 'slowness_scope']
        };

        Object.entries(categories).forEach(([categoryName, keys]) => {
          const categoryParams = keys.filter(key => params.has(key));

          if (categoryParams.length > 0) {
            const categorySection = document.createElement('div');
            categorySection.style.marginTop = '16px';

            const categoryTitle = document.createElement('h4');
            categoryTitle.textContent = categoryName;
            categoryTitle.style.fontSize = '13px';
            categoryTitle.style.fontWeight = '600';
            categoryTitle.style.color = '#475569';
            categoryTitle.style.marginBottom = '8px';
            categorySection.appendChild(categoryTitle);

            const paramsList = document.createElement('ul');
            paramsList.className = 'diagnostic-params-list';

            categoryParams.forEach(key => {
              const value = params.get(key);
              const li = document.createElement('li');

              // Format the key for display
              const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

              // Format boolean values
              let displayValue = value;
              if (value === 'true') displayValue = 'Yes';
              if (value === 'false') displayValue = 'No';

              li.innerHTML = `<strong>${formattedKey}:</strong> ${displayValue}`;
              paramsList.appendChild(li);
            });

            categorySection.appendChild(paramsList);
            summary.appendChild(categorySection);
          }
        });

        summaryContainer.appendChild(summary);
      }

      // Export diagnostic summary function
      function exportDiagnosticSummary() {
        const params = new URLSearchParams(window.location.search);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);

        // Create a structured data object
        const diagnosticData = {
          exportedAt: new Date().toISOString(),
          exportedAtFormatted: new Date().toLocaleString(),
          summary: {}
        };

        // Group parameters by category
        const categories = {
          'Scope & Target': ['scope', 'target'],
          'Timing Pattern': ['timing', 'intermittent', 'recent_change'],
          'Environment': ['device', 'os', 'connection'],
          'Quick Checks': ['high_latency', 'low_bandwidth', 'dns_issues', 'dns_ms', 'latency_ms', 'ttfb_ms', 'throughput_mbps'],
          'Diagnostic Path': ['diagnostic_path'],
          'Network Diagnostic': ['vpn_issue', 'slowness_scope'],
          'Manual Metrics': ['cpu_usage', 'load_average', 'disk_latency', 'memory_usage']
        };

        Object.entries(categories).forEach(([categoryName, keys]) => {
          const categoryParams = {};
          keys.forEach(key => {
            if (params.has(key)) {
              let value = params.get(key);
              // Format boolean values
              if (value === 'true') value = true;
              if (value === 'false') value = false;
              // Convert numeric values
              if (!isNaN(value) && value !== '') value = parseFloat(value);
              categoryParams[key] = value;
            }
          });

          if (Object.keys(categoryParams).length > 0) {
            diagnosticData.summary[categoryName] = categoryParams;
          }
        });

        // Create JSON string with proper formatting
        const jsonString = JSON.stringify(diagnosticData, null, 2);

        // Create a blob and download link
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `diagnostic-summary-${timestamp}.json`;

        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Show success feedback
        const exportButton = document.getElementById('exportButton');
        const originalText = exportButton.innerHTML;
        exportButton.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M13.3334 4L6.00002 11.3333L2.66669 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Exported!
        `;
        exportButton.disabled = true;

        setTimeout(() => {
          exportButton.innerHTML = originalText;
          exportButton.disabled = false;
        }, 2000);
      }
    </script>
  </body>
</html>
